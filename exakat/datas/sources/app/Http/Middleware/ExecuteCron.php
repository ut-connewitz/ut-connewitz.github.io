<span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><a name="l1" /><br /><a name="l2" /></span><span style="color: #007700">namespace&nbsp;</span><span style="color: #0000BB">App</span><span style="color: #007700">\</span><span style="color: #0000BB">Http</span><span style="color: #007700">\</span><span style="color: #0000BB">Middleware</span><span style="color: #007700">;<br /><a name="l3" /><br /><a name="l4" />use&nbsp;</span><span style="color: #0000BB">Closure</span><span style="color: #007700">;<br /><a name="l5" />use&nbsp;</span><span style="color: #0000BB">Artisan</span><span style="color: #007700">;<br /><a name="l6" /><br /><a name="l7" />use&nbsp;</span><span style="color: #0000BB">Illuminate</span><span style="color: #007700">\</span><span style="color: #0000BB">Support</span><span style="color: #007700">\</span><span style="color: #0000BB">Facades</span><span style="color: #007700">\</span><span style="color: #0000BB">DB</span><span style="color: #007700">;<br /><a name="l8" />use&nbsp;</span><span style="color: #0000BB">App</span><span style="color: #007700">\</span><span style="color: #0000BB">Jobs</span><span style="color: #007700">\</span><span style="color: #0000BB">CaldavSync</span><span style="color: #007700">;<br /><a name="l9" /><br /><a name="l10" />class&nbsp;</span><span style="color: #0000BB">ExecuteCron<br /><a name="l11" /></span><span style="color: #007700">{<br /><a name="l12" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l13" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Handle&nbsp;an&nbsp;incoming&nbsp;request.<br /><a name="l14" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /><a name="l15" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;&nbsp;\Illuminate\Http\Request&nbsp;&nbsp;$request<br /><a name="l16" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;&nbsp;\Closure&nbsp;&nbsp;$next<br /><a name="l17" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;mixed<br /><a name="l18" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l19" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">handle</span><span style="color: #007700">(</span><span style="color: #0000BB">$request</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">Closure&nbsp;$next</span><span style="color: #007700">)<br /><a name="l20" />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><a name="l21" /><br /><a name="l22" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;Artisan::call('schedule:run');<br /><a name="l23" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Artisan::call('foo:bar');<br /><a name="l24" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;exec('php&nbsp;-d&nbsp;register_argc_argv=On&nbsp;/var/www/artisan&nbsp;schedule:run');<br /><a name="l25" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;$schedule-&gt;exec('php&nbsp;-d&nbsp;register_argc_argv=On&nbsp;/path/to/artisan&nbsp;newsletter:send')<br /><a name="l26" /><br /><a name="l27" /><br /><a name="l28" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;$updatePeriod&nbsp;=&nbsp;60*60*24;<br /><a name="l29" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;$time&nbsp;=&nbsp;time();<br /><a name="l30" /><br /><a name="l31" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;$lastUpdate&nbsp;=&nbsp;DB::table('system')<br /><a name="l32" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;where("name",&nbsp;"cronjob-caldavsync-last-update")<br /><a name="l33" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;value("value");<br /><a name="l34" /><br /><a name="l35" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;$initialSync&nbsp;=&nbsp;$lastUpdate&nbsp;==&nbsp;null&nbsp;?&nbsp;true&nbsp;:&nbsp;false;<br /><a name="l36" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;$lastUpdate&nbsp;=&nbsp;$lastUpdate&nbsp;?&nbsp;intval($lastUpdate)&nbsp;:&nbsp;0;<br /><a name="l37" /><br /><a name="l38" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;if&nbsp;($time&nbsp;-&nbsp;$updatePeriod&nbsp;&gt;=&nbsp;$lastUpdate)&nbsp;{<br /><a name="l39" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CaldavSync::dispatch();<br /><a name="l40" /><br /><a name="l41" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($initialSync)&nbsp;{<br /><a name="l42" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DB::table('system')-&gt;insert(<br /><a name="l43" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;['name'&nbsp;=&gt;&nbsp;'cronjob-caldavsync-last-update',&nbsp;'value'&nbsp;=&gt;&nbsp;$time]<br /><a name="l44" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br /><a name="l45" /><br /><a name="l46" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br /><a name="l47" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DB::table('system')<br /><a name="l48" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;where('name',&nbsp;"cronjob-caldavsync-last-update")<br /><a name="l49" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;update(['value'&nbsp;=&gt;&nbsp;$time]);<br /><a name="l50" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l51" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;}<br /><a name="l52" /><br /><a name="l53" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">return&nbsp;</span><span style="color: #0000BB">$next</span><span style="color: #007700">(</span><span style="color: #0000BB">$request</span><span style="color: #007700">);<br /><a name="l54" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l55" />}<br /><a name="l56" /></span>
</span>