<span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><a name="l1" /><br /><a name="l2" /></span><span style="color: #007700">namespace&nbsp;</span><span style="color: #0000BB">App</span><span style="color: #007700">\</span><span style="color: #0000BB">Jobs</span><span style="color: #007700">;<br /><a name="l3" /><br /><a name="l4" />use&nbsp;</span><span style="color: #0000BB">Illuminate</span><span style="color: #007700">\</span><span style="color: #0000BB">Support</span><span style="color: #007700">\</span><span style="color: #0000BB">Facades</span><span style="color: #007700">\</span><span style="color: #0000BB">DB</span><span style="color: #007700">;<br /><a name="l5" /><br /><a name="l6" />use&nbsp;</span><span style="color: #0000BB">Illuminate</span><span style="color: #007700">\</span><span style="color: #0000BB">Bus</span><span style="color: #007700">\</span><span style="color: #0000BB">Queueable</span><span style="color: #007700">;<br /><a name="l7" />use&nbsp;</span><span style="color: #0000BB">Illuminate</span><span style="color: #007700">\</span><span style="color: #0000BB">Queue</span><span style="color: #007700">\</span><span style="color: #0000BB">SerializesModels</span><span style="color: #007700">;<br /><a name="l8" />use&nbsp;</span><span style="color: #0000BB">Illuminate</span><span style="color: #007700">\</span><span style="color: #0000BB">Queue</span><span style="color: #007700">\</span><span style="color: #0000BB">InteractsWithQueue</span><span style="color: #007700">;<br /><a name="l9" />use&nbsp;</span><span style="color: #0000BB">Illuminate</span><span style="color: #007700">\</span><span style="color: #0000BB">Contracts</span><span style="color: #007700">\</span><span style="color: #0000BB">Queue</span><span style="color: #007700">\</span><span style="color: #0000BB">ShouldQueue</span><span style="color: #007700">;<br /><a name="l10" />use&nbsp;</span><span style="color: #0000BB">Illuminate</span><span style="color: #007700">\</span><span style="color: #0000BB">Foundation</span><span style="color: #007700">\</span><span style="color: #0000BB">Bus</span><span style="color: #007700">\</span><span style="color: #0000BB">Dispatchable</span><span style="color: #007700">;<br /><a name="l11" /><br /><a name="l12" />use&nbsp;</span><span style="color: #0000BB">Sabre</span><span style="color: #007700">\</span><span style="color: #0000BB">VObject</span><span style="color: #007700">;<br /><a name="l13" />use&nbsp;</span><span style="color: #0000BB">it</span><span style="color: #007700">\</span><span style="color: #0000BB">thecsea</span><span style="color: #007700">\</span><span style="color: #0000BB">simple_caldav_client</span><span style="color: #007700">\</span><span style="color: #0000BB">SimpleCalDAVClient</span><span style="color: #007700">;<br /><a name="l14" /><br /><a name="l15" />use&nbsp;</span><span style="color: #0000BB">App</span><span style="color: #007700">\</span><span style="color: #0000BB">Job</span><span style="color: #007700">;<br /><a name="l16" /><br /><a name="l17" />class&nbsp;</span><span style="color: #0000BB">CaldavSync&nbsp;</span><span style="color: #007700">implements&nbsp;</span><span style="color: #0000BB">ShouldQueue<br /><a name="l18" /></span><span style="color: #007700">{<br /><a name="l19" />&nbsp;&nbsp;&nbsp;&nbsp;use&nbsp;</span><span style="color: #0000BB">Dispatchable</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">InteractsWithQueue</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">Queueable</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">SerializesModels</span><span style="color: #007700">;<br /><a name="l20" /><br /><a name="l21" />&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;</span><span style="color: #0000BB">$caldavClient&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">;<br /><a name="l22" /><br /><a name="l23" />&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;</span><span style="color: #0000BB">$syncFromDate&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">;<br /><a name="l24" /><br /><a name="l25" />&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;</span><span style="color: #0000BB">$syncToDate&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">;<br /><a name="l26" /><br /><a name="l27" />&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;</span><span style="color: #0000BB">$alreadyImportedJobs&nbsp;</span><span style="color: #007700">=&nbsp;[];<br /><a name="l28" /><br /><a name="l29" />&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;</span><span style="color: #0000BB">$syncedEvents&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">;<br /><a name="l30" /><br /><a name="l31" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l32" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Table&nbsp;where&nbsp;to&nbsp;save&nbsp;meta&nbsp;values&nbsp;(synced&nbsp;jobs)<br /><a name="l33" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /><a name="l34" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;string<br /><a name="l35" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l36" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">private&nbsp;</span><span style="color: #0000BB">$metaTable&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"jobs_caldavsync"</span><span style="color: #007700">;<br /><a name="l37" /><br /><a name="l38" /><br /><a name="l39" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l40" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Sync&nbsp;only&nbsp;events&nbsp;with&nbsp;categories&nbsp;from&nbsp;this&nbsp;array<br /><a name="l41" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /><a name="l42" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;array<br /><a name="l43" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l44" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">private&nbsp;</span><span style="color: #0000BB">$include_only_categories&nbsp;</span><span style="color: #007700">=&nbsp;[];<br /><a name="l45" /><br /><a name="l46" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l47" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Exclude&nbsp;event&nbsp;categories&nbsp;from&nbsp;sync.<br /><a name="l48" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;if&nbsp;$include_only_categories&nbsp;is&nbsp;not&nbsp;empty,&nbsp;exclude_categories&nbsp;will&nbsp;be&nbsp;ignored<br /><a name="l49" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /><a name="l50" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;array<br /><a name="l51" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l52" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">private&nbsp;</span><span style="color: #0000BB">$exclude_categories&nbsp;</span><span style="color: #007700">=&nbsp;[];<br /><a name="l53" /><br /><a name="l54" />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">__construct</span><span style="color: #007700">()&nbsp;{<br /><a name="l55" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">caldavClient&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">SimpleCalDAVClient</span><span style="color: #007700">();<br /><a name="l56" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">syncFromDate&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">date</span><span style="color: #007700">(</span><span style="color: #DD0000">'Ymd\T000000\Z'</span><span style="color: #007700">);<br /><a name="l57" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">syncToDate&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">date</span><span style="color: #007700">(</span><span style="color: #DD0000">'Ymt\T000000\Z'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">strtotime</span><span style="color: #007700">(</span><span style="color: #DD0000">"+2&nbsp;months"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">strtotime</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">syncFromDate</span><span style="color: #007700">)));<br /><a name="l58" /><br /><a name="l59" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l60" /><br /><a name="l61" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;public&nbsp;function&nbsp;MayHandle()&nbsp;{<br /><a name="l62" />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;sleep(20);<br /><a name="l63" />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;return&nbsp;$this-&gt;syncedEvents;<br /><a name="l64" /><br /><a name="l65" />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$time&nbsp;=&nbsp;time();<br /><a name="l66" /><br /><a name="l67" />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$lastUpdate&nbsp;=&nbsp;$this-&gt;getLastUpdate();<br /><a name="l68" />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$lastUpdate&nbsp;=&nbsp;$lastUpdate&nbsp;?&nbsp;intval($lastUpdate)&nbsp;:&nbsp;0;<br /><a name="l69" />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$updatePeriod&nbsp;=&nbsp;$this-&gt;getUpdatePeriod();<br /><a name="l70" />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($time&nbsp;-&nbsp;$updatePeriod&nbsp;&gt;=&nbsp;$lastUpdate)&nbsp;{<br /><a name="l71" />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;handle();<br /><a name="l72" />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;setLastUpdate($time);<br /><a name="l73" />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l74" />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;}<br /><a name="l75" /><br /><a name="l76" />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;private&nbsp;function&nbsp;test()&nbsp;&nbsp;{<br /><a name="l77" />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DB::table('activity')-&gt;insert(<br /><a name="l78" />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;['type'&nbsp;=&gt;&nbsp;'info',&nbsp;'target_type'&nbsp;=&gt;&nbsp;'caldavsync',&nbsp;'message'&nbsp;=&gt;&nbsp;time()]<br /><a name="l79" />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br /><a name="l80" />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;}<br /><a name="l81" /><br /><a name="l82" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">handle</span><span style="color: #007700">()&nbsp;{<br /><a name="l83" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$calendars&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getCalendars</span><span style="color: #007700">();<br /><a name="l84" /><br /><a name="l85" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(empty(</span><span style="color: #0000BB">$calendars</span><span style="color: #007700">))&nbsp;{<br /><a name="l86" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br /><a name="l87" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l88" /><br /><a name="l89" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;get&nbsp;already&nbsp;by&nbsp;caldav&nbsp;imported&nbsp;jobs<br /><a name="l90" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$alreadyImportedJobs&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">DB</span><span style="color: #007700">::</span><span style="color: #0000BB">table</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">metaTable</span><span style="color: #007700">)<br /><a name="l91" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">where</span><span style="color: #007700">(</span><span style="color: #DD0000">"meta_key"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"caldav_sync"</span><span style="color: #007700">)<br /><a name="l92" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">get</span><span style="color: #007700">();<br /><a name="l93" /><br /><a name="l94" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000BB">$alreadyImportedJobs&nbsp;</span><span style="color: #007700">as&nbsp;</span><span style="color: #0000BB">$key&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$job</span><span style="color: #007700">)&nbsp;{<br /><a name="l95" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">alreadyImportedJobs</span><span style="color: #007700">[]&nbsp;=&nbsp;</span><span style="color: #0000BB">array_merge</span><span style="color: #007700">(&nbsp;</span><span style="color: #0000BB">json_decode</span><span style="color: #007700">(</span><span style="color: #0000BB">$job</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">meta_value</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">),&nbsp;[</span><span style="color: #DD0000">"job_id"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$job</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">job_id</span><span style="color: #007700">]&nbsp;);<br /><a name="l96" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l97" /><br /><a name="l98" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$eventsToImport&nbsp;</span><span style="color: #007700">=&nbsp;[];<br /><a name="l99" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$insertErrors&nbsp;</span><span style="color: #007700">=&nbsp;[];<br /><a name="l100" /><br /><a name="l101" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000BB">$calendars&nbsp;</span><span style="color: #007700">as&nbsp;</span><span style="color: #0000BB">$key&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$calendar</span><span style="color: #007700">)&nbsp;{<br /><a name="l102" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">syncCalendar</span><span style="color: #007700">(</span><span style="color: #0000BB">$calendar</span><span style="color: #007700">);<br /><a name="l103" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l104" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l105" /><br /><a name="l106" />&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;function&nbsp;</span><span style="color: #0000BB">syncCalendar</span><span style="color: #007700">(</span><span style="color: #0000BB">$calendar&nbsp;</span><span style="color: #007700">=&nbsp;[])&nbsp;{<br /><a name="l107" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$events&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetchEventsFromCalendar</span><span style="color: #007700">(</span><span style="color: #0000BB">$calendar</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">syncFromDate</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">syncToDate</span><span style="color: #007700">);<br /><a name="l108" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(empty(</span><span style="color: #0000BB">$events</span><span style="color: #007700">))&nbsp;&nbsp;{<br /><a name="l109" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">;<br /><a name="l110" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l111" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000BB">$events&nbsp;</span><span style="color: #007700">as&nbsp;</span><span style="color: #0000BB">$key&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$event</span><span style="color: #007700">)&nbsp;{<br /><a name="l112" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$event&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$event</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getData</span><span style="color: #007700">();<br /><a name="l113" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$vcard&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">VObject</span><span style="color: #007700">\</span><span style="color: #0000BB">Reader</span><span style="color: #007700">::</span><span style="color: #0000BB">read</span><span style="color: #007700">(</span><span style="color: #0000BB">$event</span><span style="color: #007700">);<br /><a name="l114" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$event&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$vcard</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">VEVENT</span><span style="color: #007700">;<br /><a name="l115" /><br /><a name="l116" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;echo&nbsp;$event-&gt;serialize();<br /><a name="l117" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;echo&nbsp;"&lt;br&gt;";<br /><a name="l118" /><br /><a name="l119" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$eventId&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$event</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">UID</span><span style="color: #007700">;<br /><a name="l120" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$calendarId&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$calendar</span><span style="color: #007700">[</span><span style="color: #DD0000">'calendar'</span><span style="color: #007700">];<br /><a name="l121" /><br /><a name="l122" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$exists&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">array_filter</span><span style="color: #007700">(<br /><a name="l123" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">alreadyImportedJobs</span><span style="color: #007700">,<br /><a name="l124" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;function(</span><span style="color: #0000BB">$v</span><span style="color: #007700">)&nbsp;use&nbsp;(</span><span style="color: #0000BB">$eventId</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$calendarId</span><span style="color: #007700">)&nbsp;{<br /><a name="l125" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$v</span><span style="color: #007700">[</span><span style="color: #DD0000">'calendar'</span><span style="color: #007700">]&nbsp;==&nbsp;</span><span style="color: #0000BB">$calendarId&nbsp;</span><span style="color: #007700">&amp;&amp;&nbsp;</span><span style="color: #0000BB">$v</span><span style="color: #007700">[</span><span style="color: #DD0000">'eventId'</span><span style="color: #007700">]&nbsp;==&nbsp;</span><span style="color: #0000BB">$eventId</span><span style="color: #007700">;<br /><a name="l126" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l127" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br /><a name="l128" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(empty(</span><span style="color: #0000BB">$exists</span><span style="color: #007700">))&nbsp;{<br /><a name="l129" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;$eventsToImport[]&nbsp;=&nbsp;$event;<br /><a name="l130" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">syncEvent</span><span style="color: #007700">(</span><span style="color: #0000BB">$calendar</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$event</span><span style="color: #007700">);<br /><a name="l131" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l132" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l133" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l134" /><br /><a name="l135" />&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;function&nbsp;</span><span style="color: #0000BB">syncEvent</span><span style="color: #007700">(</span><span style="color: #0000BB">$calendar</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$event</span><span style="color: #007700">)&nbsp;{<br /><a name="l136" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!</span><span style="color: #0000BB">$event</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">UID&nbsp;</span><span style="color: #007700">||&nbsp;!</span><span style="color: #0000BB">$event</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">SUMMARY</span><span style="color: #007700">)&nbsp;{<br /><a name="l137" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br /><a name="l138" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l139" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$uid&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$event</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">UID</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getValue</span><span style="color: #007700">();<br /><a name="l140" /><br /><a name="l141" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$start&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$event</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">DTSTART&nbsp;</span><span style="color: #007700">?&nbsp;</span><span style="color: #0000BB">$event</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">DTSTART</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getDateTime</span><span style="color: #007700">()&nbsp;:&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">;<br /><a name="l142" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$end&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$event</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">DTEND&nbsp;</span><span style="color: #007700">?&nbsp;</span><span style="color: #0000BB">$event</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">DTEND</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getDateTime</span><span style="color: #007700">()&nbsp;:&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">;<br /><a name="l143" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$jobData&nbsp;</span><span style="color: #007700">=&nbsp;[<br /><a name="l144" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"title"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$event</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">SUMMARY</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getValue</span><span style="color: #007700">(),<br /><a name="l145" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"description"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$event</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">DESCRIPTION&nbsp;</span><span style="color: #007700">?&nbsp;</span><span style="color: #0000BB">$event</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">DESCRIPTION</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getValue</span><span style="color: #007700">()&nbsp;:&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">,<br /><a name="l146" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"start_date"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$start&nbsp;</span><span style="color: #007700">?&nbsp;</span><span style="color: #0000BB">$start</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">format</span><span style="color: #007700">(</span><span style="color: #DD0000">'Y-m-d'</span><span style="color: #007700">)&nbsp;:&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">,<br /><a name="l147" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"start_time"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$start&nbsp;</span><span style="color: #007700">?&nbsp;</span><span style="color: #0000BB">$start</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">format</span><span style="color: #007700">(</span><span style="color: #DD0000">'H:i'</span><span style="color: #007700">)&nbsp;:&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">,<br /><a name="l148" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"end_date"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$end&nbsp;</span><span style="color: #007700">?&nbsp;</span><span style="color: #0000BB">$end</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">format</span><span style="color: #007700">(</span><span style="color: #DD0000">'Y-m-d'</span><span style="color: #007700">)&nbsp;:&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">,<br /><a name="l149" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"end_time"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$end&nbsp;</span><span style="color: #007700">?&nbsp;</span><span style="color: #0000BB">$end</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">format</span><span style="color: #007700">(</span><span style="color: #DD0000">'H:i'</span><span style="color: #007700">)&nbsp;:&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">,<br /><a name="l150" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;TODO&nbsp;"creator"&nbsp;=&gt;&nbsp;???<br /><a name="l151" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;TODO&nbsp;category&nbsp;as&nbsp;add&nbsp;($event-&gt;CATEGORIES)<br /><a name="l152" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;TODO&nbsp;location&nbsp;as&nbsp;add&nbsp;($event-&gt;LOCATION)<br /><a name="l153" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">];<br /><a name="l154" /><br /><a name="l155" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;var_dump($jobData);<br /><a name="l156" /><br /><a name="l157" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;if&nbsp;($event-&gt;CATEGORIES)&nbsp;{<br /><a name="l158" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$categories&nbsp;=&nbsp;explode(",",&nbsp;$event-&gt;CATEGORIES-&gt;getValue());<br /><a name="l159" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;var_dump($categories);<br /><a name="l160" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;}<br /><a name="l161" /><br /><a name="l162" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$job&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Job</span><span style="color: #007700">::</span><span style="color: #0000BB">create</span><span style="color: #007700">(</span><span style="color: #0000BB">$jobData</span><span style="color: #007700">);<br /><a name="l163" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$metaData&nbsp;</span><span style="color: #007700">=&nbsp;[<br /><a name="l164" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"job_id"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$job</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">id</span><span style="color: #007700">,<br /><a name="l165" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"meta_key"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"caldav_sync"</span><span style="color: #007700">,<br /><a name="l166" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"meta_value"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">json_encode</span><span style="color: #007700">([<br /><a name="l167" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"calendar"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$calendar</span><span style="color: #007700">[</span><span style="color: #DD0000">'calendar'</span><span style="color: #007700">],<br /><a name="l168" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"eventId"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$uid</span><span style="color: #007700">,<br /><a name="l169" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"imported_at"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">date</span><span style="color: #007700">(</span><span style="color: #DD0000">"Y-m-d&nbsp;H:i:s"</span><span style="color: #007700">)<br /><a name="l170" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;])<br /><a name="l171" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];<br /><a name="l172" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">syncedEvents</span><span style="color: #007700">++;<br /><a name="l173" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">DB</span><span style="color: #007700">::</span><span style="color: #0000BB">table</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">metaTable</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">insert</span><span style="color: #007700">(</span><span style="color: #0000BB">$metaData</span><span style="color: #007700">);<br /><a name="l174" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l175" /><br /><a name="l176" />&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;function&nbsp;</span><span style="color: #0000BB">fetchEventsFromCalendar</span><span style="color: #007700">(</span><span style="color: #0000BB">$calendar&nbsp;</span><span style="color: #007700">=&nbsp;[],&nbsp;</span><span style="color: #0000BB">$fromDate&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$toDate&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">)&nbsp;{<br /><a name="l177" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$events&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">;<br /><a name="l178" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br /><a name="l179" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">caldavClient</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connect</span><span style="color: #007700">(</span><span style="color: #0000BB">$calendar</span><span style="color: #007700">[</span><span style="color: #DD0000">'host'</span><span style="color: #007700">],&nbsp;</span><span style="color: #0000BB">$calendar</span><span style="color: #007700">[</span><span style="color: #DD0000">'username'</span><span style="color: #007700">],&nbsp;</span><span style="color: #0000BB">$calendar</span><span style="color: #007700">[</span><span style="color: #DD0000">'password'</span><span style="color: #007700">]);<br /><a name="l180" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$arrayOfCalendars&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">caldavClient</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">findCalendars</span><span style="color: #007700">();<br /><a name="l181" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">caldavClient</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setCalendar</span><span style="color: #007700">(</span><span style="color: #0000BB">$arrayOfCalendars</span><span style="color: #007700">[</span><span style="color: #0000BB">$calendar</span><span style="color: #007700">[</span><span style="color: #DD0000">'calendar'</span><span style="color: #007700">]]);<br /><a name="l182" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$events&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">caldavClient</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getEvents</span><span style="color: #007700">(</span><span style="color: #0000BB">$fromDate</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$toDate</span><span style="color: #007700">);<br /><a name="l183" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(</span><span style="color: #0000BB">Exception&nbsp;$e</span><span style="color: #007700">)&nbsp;{<br /><a name="l184" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;throw&nbsp;new&nbsp;Exception($e-&gt;__toString());<br /><a name="l185" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">return&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">;<br /><a name="l186" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l187" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$events</span><span style="color: #007700">;<br /><a name="l188" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l189" /><br /><a name="l190" />&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;function&nbsp;</span><span style="color: #0000BB">getCalendars</span><span style="color: #007700">()&nbsp;{<br /><a name="l191" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">config</span><span style="color: #007700">(</span><span style="color: #DD0000">'caldav'</span><span style="color: #007700">,&nbsp;[]);<br /><a name="l192" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l193" /><br /><a name="l194" />&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;function&nbsp;</span><span style="color: #0000BB">getLastUpdate</span><span style="color: #007700">()&nbsp;{<br /><a name="l195" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$lastUpdate&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">DB</span><span style="color: #007700">::</span><span style="color: #0000BB">table</span><span style="color: #007700">(</span><span style="color: #DD0000">'system'</span><span style="color: #007700">)<br /><a name="l196" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">where</span><span style="color: #007700">(</span><span style="color: #DD0000">"name"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"cronjob-caldavsync-last-update"</span><span style="color: #007700">)<br /><a name="l197" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">value</span><span style="color: #007700">(</span><span style="color: #DD0000">"value"</span><span style="color: #007700">);<br /><a name="l198" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">lastUpdate&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$lastUpdate</span><span style="color: #007700">;<br /><a name="l199" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$lastUpdate</span><span style="color: #007700">;<br /><a name="l200" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l201" /><br /><a name="l202" />&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;function&nbsp;</span><span style="color: #0000BB">setLastUpdate</span><span style="color: #007700">(</span><span style="color: #0000BB">$time&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">)&nbsp;{<br /><a name="l203" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$time&nbsp;</span><span style="color: #007700">===&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">)&nbsp;{<br /><a name="l204" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$time&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">time</span><span style="color: #007700">();<br /><a name="l205" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l206" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$lastUpdate&nbsp;</span><span style="color: #007700">=&nbsp;!</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">lastUpdate<br /><a name="l207" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">?&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getLastUpdate</span><span style="color: #007700">()<br /><a name="l208" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">lastUpdate</span><span style="color: #007700">;<br /><a name="l209" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$initialSync&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$lastUpdate&nbsp;</span><span style="color: #007700">==&nbsp;</span><span style="color: #0000BB">null&nbsp;</span><span style="color: #007700">?&nbsp;</span><span style="color: #0000BB">true&nbsp;</span><span style="color: #007700">:&nbsp;</span><span style="color: #0000BB">false</span><span style="color: #007700">;<br /><a name="l210" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$initialSync</span><span style="color: #007700">)&nbsp;{<br /><a name="l211" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">DB</span><span style="color: #007700">::</span><span style="color: #0000BB">table</span><span style="color: #007700">(</span><span style="color: #DD0000">'system'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">insert</span><span style="color: #007700">(<br /><a name="l212" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[</span><span style="color: #DD0000">'name'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'cronjob-caldavsync-last-update'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'value'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$time</span><span style="color: #007700">]<br /><a name="l213" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br /><a name="l214" /><br /><a name="l215" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br /><a name="l216" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">DB</span><span style="color: #007700">::</span><span style="color: #0000BB">table</span><span style="color: #007700">(</span><span style="color: #DD0000">'system'</span><span style="color: #007700">)<br /><a name="l217" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">where</span><span style="color: #007700">(</span><span style="color: #DD0000">'name'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"cronjob-caldavsync-last-update"</span><span style="color: #007700">)<br /><a name="l218" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">update</span><span style="color: #007700">([</span><span style="color: #DD0000">'value'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$time</span><span style="color: #007700">]);<br /><a name="l219" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l220" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l221" /><br /><a name="l222" />&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;function&nbsp;</span><span style="color: #0000BB">getUpdatePeriod&nbsp;</span><span style="color: #007700">()&nbsp;{<br /><a name="l223" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">60</span><span style="color: #007700">*</span><span style="color: #0000BB">60</span><span style="color: #007700">*</span><span style="color: #0000BB">24</span><span style="color: #007700">;<br /><a name="l224" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l225" />}<br /><a name="l226" /><br /><a name="l227" /></span><span style="color: #0000BB">?&gt;</span>
</span>